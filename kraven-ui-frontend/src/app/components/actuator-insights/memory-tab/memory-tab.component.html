<div class="memory-tab-container">
  <div class="tab-header">
    <h2>Memory Analysis</h2>
    <div class="tab-controls">
      <button class="take-dump-button" (click)="requestHeapDump()" [disabled]="isRequestingDump">
        <i class="fas" [ngClass]="isRequestingDump ? 'fa-spinner fa-spin' : 'fa-save'"></i> Save Heap Dump to Server
      </button>

    </div>
  </div>

  <!-- Loading indicator -->
  <div class="loading-indicator" *ngIf="isLoading">
    <i class="fas fa-spinner fa-spin"></i>
    <span>Loading memory data...</span>
  </div>



  <!-- Secondary Tabs -->
  <div class="secondary-tabs" *ngIf="!isLoading && (memoryData || heapDumpExists)">
    <div class="tab" [class.active]="activeSecondaryTab === 'overview'" (click)="switchSecondaryTab('overview')" *ngIf="memoryData">
      <i class="fas fa-chart-pie"></i> Overview
    </div>
    <div class="tab" [class.active]="activeSecondaryTab === 'heap'" (click)="switchSecondaryTab('heap')" *ngIf="memoryData">
      <i class="fas fa-memory"></i> Heap Memory
    </div>
    <div class="tab" [class.active]="activeSecondaryTab === 'nonheap'" (click)="switchSecondaryTab('nonheap')" *ngIf="memoryData">
      <i class="fas fa-microchip"></i> Non-Heap Memory
    </div>
    <div class="tab" [class.active]="activeSecondaryTab === 'gc'" (click)="switchSecondaryTab('gc')" *ngIf="memoryData">
      <i class="fas fa-trash-alt"></i> Garbage Collection
    </div>
    <div class="tab" [class.active]="activeSecondaryTab === 'analysis'" (click)="switchSecondaryTab('analysis')">
      <i class="fas fa-search-plus"></i> Analysis
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content" *ngIf="!isLoading && (memoryData || (heapDumpExists && activeSecondaryTab === 'analysis'))">
    <!-- Overview Tab -->
    <div class="memory-overview" *ngIf="activeSecondaryTab === 'overview' && memoryData">
      <div class="memory-summary">
        <div class="memory-card">
          <div class="memory-card-header">
            <h3>Heap Memory</h3>
            <div class="memory-actions">

            </div>
          </div>
          <div class="memory-card-content">
            <div class="memory-usage">
              <div class="memory-usage-header">
                <span>Used</span>
                <span>{{ formatBytes(memoryData?.heap?.used || 0) }} / {{ formatBytes(memoryData?.heap?.max || 0) }}</span>
              </div>
              <div class="memory-progress-bar">
                <div class="memory-progress"
                     [style.width.%]="calculatePercentage(memoryData?.heap?.used || 0, memoryData?.heap?.max || 0)"
                     [style.background-color]="getColorByPercentage(calculatePercentage(memoryData?.heap?.used || 0, memoryData?.heap?.max || 0))">
                </div>
              </div>
              <div class="memory-usage-details">
                <div class="memory-detail">
                  <span>Init</span>
                  <span>{{ formatBytes(memoryData?.heap?.init || 0) }}</span>
                </div>
                <div class="memory-detail">
                  <span>Committed</span>
                  <span>{{ formatBytes(memoryData?.heap?.committed || 0) }}</span>
                </div>
                <div class="memory-detail">
                  <span>Used</span>
                  <span>{{ formatBytes(memoryData?.heap?.used || 0) }}</span>
                </div>
                <div class="memory-detail">
                  <span>Max</span>
                  <span>{{ formatBytes(memoryData?.heap?.max || 0) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="memory-card">
          <div class="memory-card-header">
            <h3>Non-Heap Memory</h3>
          </div>
          <div class="memory-card-content">
            <div class="memory-usage">
              <div class="memory-usage-header">
                <span>Used</span>
                <span>{{ formatBytes(memoryData?.nonHeap?.used || 0) }} / {{ formatBytes(memoryData?.nonHeap?.committed || 0) }}</span>
              </div>
              <div class="memory-progress-bar">
                <div class="memory-progress"
                     [style.width.%]="calculatePercentage(memoryData?.nonHeap?.used || 0, memoryData?.nonHeap?.committed || 0)"
                     [style.background-color]="getColorByPercentage(calculatePercentage(memoryData?.nonHeap?.used || 0, memoryData?.nonHeap?.committed || 0))">
                </div>
              </div>
              <div class="memory-usage-details">
                <div class="memory-detail">
                  <span>Init</span>
                  <span>{{ formatBytes(memoryData?.nonHeap?.init || 0) }}</span>
                </div>
                <div class="memory-detail">
                  <span>Committed</span>
                  <span>{{ formatBytes(memoryData?.nonHeap?.committed || 0) }}</span>
                </div>
                <div class="memory-detail">
                  <span>Used</span>
                  <span>{{ formatBytes(memoryData?.nonHeap?.used || 0) }}</span>
                </div>
                <div class="memory-detail">
                  <span>Max</span>
                  <span>{{ formatBytes(memoryData?.nonHeap?.max || 0) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Memory Pools Overview -->
      <div class="memory-pools-section">
        <h3>Memory Pools</h3>
        <div class="memory-pools">
          <div class="memory-pool" *ngFor="let pool of memoryData?.memoryPools">
            <div class="memory-pool-header">
              <span class="memory-pool-name">{{ pool.name }}</span>
              <span class="memory-pool-type">{{ pool.type }}</span>
            </div>
            <div class="memory-usage">
              <div class="memory-usage-header">
                <span>Used</span>
                <span>{{ formatBytes(pool.usage?.used || 0) }} / {{ formatBytes(pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0) }}</span>
              </div>
              <div class="memory-progress-bar">
                <div class="memory-progress"
                     [style.width.%]="calculatePercentage(pool.usage?.used || 0, pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0)"
                     [style.background-color]="getColorByPercentage(calculatePercentage(pool.usage?.used || 0, pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0))">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- GC Overview -->
      <div class="gc-section">
        <h3>Garbage Collectors</h3>
        <div class="gc-collectors">
          <div class="gc-collector" *ngFor="let gc of memoryData?.garbageCollectors">
            <div class="gc-collector-header">
              <span class="gc-collector-name">{{ gc.name }}</span>
            </div>
            <div class="gc-collector-stats">
              <div class="gc-stat">
                <span>Collection Count</span>
                <span>{{ gc.collectionCount }}</span>
              </div>
              <div class="gc-stat">
                <span>Collection Time</span>
                <span>{{ gc.collectionTime }} ms</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Heap Memory Tab -->
    <div class="memory-detail-view" *ngIf="activeSecondaryTab === 'heap'">
      <div class="memory-detail-header">
        <h3>Heap Memory Details</h3>
        <div class="memory-actions">
          <button class="heap-dump-button" (click)="requestHeapDump()">
            <i class="fas fa-save"></i> Save Heap Dump to Server
          </button>
        </div>
      </div>

      <!-- Heap Memory Pools -->
      <div class="memory-pools-detailed">
        <div class="memory-pool-detailed" *ngFor="let pool of memoryData?.memoryPools">
          <ng-container *ngIf="pool.type === 'Heap memory'">
            <div class="memory-pool-header">
              <h4>{{ pool.name }}</h4>
            </div>
            <div class="memory-pool-content">
              <div class="memory-usage">
                <div class="memory-usage-header">
                  <span>Used</span>
                  <span>{{ formatBytes(pool.usage?.used || 0) }} / {{ formatBytes(pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0) }}</span>
                </div>
                <div class="memory-progress-bar">
                  <div class="memory-progress"
                       [style.width.%]="calculatePercentage(pool.usage?.used || 0, pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0)"
                       [style.background-color]="getColorByPercentage(calculatePercentage(pool.usage?.used || 0, pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0))">
                  </div>
                </div>
                <div class="memory-usage-details">
                  <div class="memory-detail">
                    <span>Init</span>
                    <span>{{ formatBytes(pool.usage?.init || 0) }}</span>
                  </div>
                  <div class="memory-detail">
                    <span>Committed</span>
                    <span>{{ formatBytes(pool.usage?.committed || 0) }}</span>
                  </div>
                  <div class="memory-detail">
                    <span>Used</span>
                    <span>{{ formatBytes(pool.usage?.used || 0) }}</span>
                  </div>
                  <div class="memory-detail">
                    <span>Max</span>
                    <span>{{ formatBytes(pool.usage?.max || 0) }}</span>
                  </div>
                </div>
              </div>

              <!-- Peak Usage -->
              <div class="memory-usage" *ngIf="pool.peakUsage">
                <h5>Peak Usage</h5>
                <div class="memory-usage-header">
                  <span>Used</span>
                  <span>{{ formatBytes(pool.peakUsage?.used || 0) }} / {{ formatBytes(pool.peakUsage?.max > 0 ? pool.peakUsage?.max : pool.peakUsage?.committed || 0) }}</span>
                </div>
                <div class="memory-progress-bar">
                  <div class="memory-progress"
                       [style.width.%]="calculatePercentage(pool.peakUsage?.used || 0, pool.peakUsage?.max > 0 ? pool.peakUsage?.max : pool.peakUsage?.committed || 0)"
                       [style.background-color]="getColorByPercentage(calculatePercentage(pool.peakUsage?.used || 0, pool.peakUsage?.max > 0 ? pool.peakUsage?.max : pool.peakUsage?.committed || 0))">
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- Non-Heap Memory Tab -->
    <div class="memory-detail-view" *ngIf="activeSecondaryTab === 'nonheap'">
      <div class="memory-detail-header">
        <h3>Non-Heap Memory Details</h3>
      </div>

      <!-- Non-Heap Memory Pools -->
      <div class="memory-pools-detailed">
        <div class="memory-pool-detailed" *ngFor="let pool of memoryData?.memoryPools">
          <ng-container *ngIf="pool.type === 'Non-heap memory'">
            <div class="memory-pool-header">
              <h4>{{ pool.name }}</h4>
            </div>
            <div class="memory-pool-content">
              <div class="memory-usage">
                <div class="memory-usage-header">
                  <span>Used</span>
                  <span>{{ formatBytes(pool.usage?.used || 0) }} / {{ formatBytes(pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0) }}</span>
                </div>
                <div class="memory-progress-bar">
                  <div class="memory-progress"
                       [style.width.%]="calculatePercentage(pool.usage?.used || 0, pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0)"
                       [style.background-color]="getColorByPercentage(calculatePercentage(pool.usage?.used || 0, pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0))">
                  </div>
                </div>
                <div class="memory-usage-details">
                  <div class="memory-detail">
                    <span>Init</span>
                    <span>{{ formatBytes(pool.usage?.init || 0) }}</span>
                  </div>
                  <div class="memory-detail">
                    <span>Committed</span>
                    <span>{{ formatBytes(pool.usage?.committed || 0) }}</span>
                  </div>
                  <div class="memory-detail">
                    <span>Used</span>
                    <span>{{ formatBytes(pool.usage?.used || 0) }}</span>
                  </div>
                  <div class="memory-detail">
                    <span>Max</span>
                    <span>{{ formatBytes(pool.usage?.max || 0) }}</span>
                  </div>
                </div>
              </div>

              <!-- Peak Usage -->
              <div class="memory-usage" *ngIf="pool.peakUsage">
                <h5>Peak Usage</h5>
                <div class="memory-usage-header">
                  <span>Used</span>
                  <span>{{ formatBytes(pool.peakUsage?.used || 0) }} / {{ formatBytes(pool.peakUsage?.max > 0 ? pool.peakUsage?.max : pool.peakUsage?.committed || 0) }}</span>
                </div>
                <div class="memory-progress-bar">
                  <div class="memory-progress"
                       [style.width.%]="calculatePercentage(pool.peakUsage?.used || 0, pool.peakUsage?.max > 0 ? pool.peakUsage?.max : pool.peakUsage?.committed || 0)"
                       [style.background-color]="getColorByPercentage(calculatePercentage(pool.peakUsage?.used || 0, pool.peakUsage?.max > 0 ? pool.peakUsage?.max : pool.peakUsage?.committed || 0))">
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- Garbage Collection Tab -->
    <div class="memory-detail-view" *ngIf="activeSecondaryTab === 'gc'">
      <div class="memory-detail-header">
        <h3>Garbage Collection Details</h3>
      </div>

      <!-- GC Details -->
      <div class="gc-collectors-detailed">
        <div class="gc-collector-detailed" *ngFor="let gc of memoryData?.garbageCollectors">
          <div class="gc-collector-header">
            <h4>{{ gc.name }}</h4>
          </div>
          <div class="gc-collector-content">
            <div class="gc-collector-stats">
              <div class="gc-stat">
                <span>Collection Count</span>
                <span>{{ gc.collectionCount }}</span>
              </div>
              <div class="gc-stat">
                <span>Collection Time</span>
                <span>{{ gc.collectionTime }} ms</span>
              </div>
              <div class="gc-stat">
                <span>Average Collection Time</span>
                <span>{{ gc.collectionCount > 0 ? (gc.collectionTime / gc.collectionCount).toFixed(2) : 0 }} ms</span>
              </div>
            </div>

            <!-- Memory Pools Managed by this GC -->
            <div class="gc-managed-pools" *ngIf="gc.memoryPoolNames && gc.memoryPoolNames.length > 0">
              <h5>Managed Memory Pools</h5>
              <ul class="gc-pool-list">
                <li *ngFor="let poolName of gc.memoryPoolNames">{{ poolName }}</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Memory Analysis Tab -->
    <div class="memory-analysis-view" *ngIf="activeSecondaryTab === 'analysis'">
      <div class="analysis-header">
        <h3>Memory Dump Analysis</h3>
        <div class="analysis-controls">
          <div class="analysis-type-selector" *ngIf="heapDumpExists">
            <label for="analysisType">Analysis Type:</label>
            <select id="analysisType" [(ngModel)]="selectedAnalysisType">
              <option *ngFor="let type of analysisTypes" [value]="type.id">{{ type.name }}</option>
            </select>
          </div>
          <button class="run-analysis-button" (click)="runAnalysis()" [disabled]="isAnalyzing || !heapDumpExists" *ngIf="heapDumpExists">
            <i class="fas" [ngClass]="isAnalyzing ? 'fa-spinner fa-spin' : 'fa-play'"></i>
            {{ isAnalyzing ? 'Analyzing...' : 'Run Analysis' }}
          </button>
          <button class="download-pdf-button" (click)="downloadPdfReport()" *ngIf="analysisResults" [disabled]="isAnalyzing">
            <i class="fas fa-file-pdf"></i>
            Download PDF
          </button>
        </div>
      </div>

      <!-- Heap dump info -->
      <div class="heap-dump-info" *ngIf="heapDumpExists && heapDumpInfo && !analysisResults && !isAnalyzing">
        <div class="info-card">
          <h4>Heap Dump Information</h4>
          <div class="info-details">
            <div class="info-item">
              <span class="info-label">File Path:</span>
              <span class="info-value">{{ heapDumpInfo.filePath }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">File Size:</span>
              <span class="info-value">{{ formatBytes(heapDumpInfo.fileSize) }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Last Modified:</span>
              <span class="info-value">{{ heapDumpInfo.lastModified | date:'medium' }}</span>
            </div>
          </div>
          <p class="info-help">Select an analysis type and click "Run Analysis" to analyze the heap dump.</p>
        </div>
      </div>

      <div class="analysis-content">
        <!-- Loading indicator -->
        <div class="analysis-loading" *ngIf="isAnalyzing">
          <i class="fas fa-spinner fa-spin"></i>
          <h4>Analyzing Memory Dump...</h4>
          <p>This may take a few moments depending on the size of the heap dump and the complexity of the analysis.</p>
        </div>

        <!-- No analysis results yet -->
        <div class="no-analysis-results" *ngIf="!isAnalyzing && !analysisResults">
          <i class="fas fa-search"></i>
          <h4>No Analysis Results</h4>
          <p>Select an analysis type and click "Run Analysis" to analyze the memory dump.</p>
        </div>

        <!-- Analysis error -->
        <div class="analysis-error" *ngIf="!isAnalyzing && analysisResults && analysisResults.error">
          <i class="fas fa-exclamation-circle"></i>
          <h4>Analysis Error</h4>
          <p>{{ analysisResults.error }}</p>
        </div>

        <!-- Analysis results -->
        <div class="analysis-results" *ngIf="!isAnalyzing && analysisResults && !analysisResults.error">
          <!-- Summary -->
          <div class="analysis-summary" *ngIf="analysisResults.summary">
            <h4>Summary</h4>
            <p>{{ analysisResults.summary }}</p>
          </div>

          <!-- Object Distribution Analysis -->
          <div class="object-distribution-results" *ngIf="selectedAnalysisType === 'objectDistribution' && analysisResults.topClasses">
            <!-- Memory Usage Overview -->
            <div class="memory-usage-overview">
              <h4>Memory Usage Overview</h4>
              <div class="memory-metrics">
                <div class="memory-metric">
                  <div class="metric-value">{{ formatBytes(analysisResults.totalHeapSize) }}</div>
                  <div class="metric-label">Total Heap Size</div>
                </div>
                <div class="memory-metric">
                  <div class="metric-value">{{ formatBytes(analysisResults.usedHeapSize) }}</div>
                  <div class="metric-label">Used Heap</div>
                </div>
                <div class="memory-metric">
                  <div class="metric-value">{{ analysisResults.objectCount.toLocaleString() }}</div>
                  <div class="metric-label">Object Count</div>
                </div>
              </div>

              <!-- Memory Regions -->
              <div class="memory-regions">
                <h5>Memory Regions</h5>
                <div class="region-bars">
                  <div class="region-bar" *ngFor="let region of analysisResults.memoryRegions">
                    <div class="region-info">
                      <span class="region-name">{{ region.name }}</span>
                      <span class="region-usage">{{ formatBytes(region.used) }} / {{ formatBytes(region.total) }}</span>
                    </div>
                    <div class="region-progress-bar">
                      <div class="region-progress"
                           [style.width.%]="calculatePercentage(region.used, region.total)"
                           [style.background-color]="getColorByPercentage(calculatePercentage(region.used, region.total))">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Top Classes -->
            <div class="top-classes">
              <h4>Top Memory Consuming Classes</h4>
              <div class="top-classes-chart" id="topClassesChart"></div>
              <div class="top-classes-table">
                <table>
                  <thead>
                    <tr>
                      <th>Class Name</th>
                      <th>Instance Count</th>
                      <th>Total Size</th>
                      <th>Avg Size</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let cls of analysisResults.topClasses">
                      <td>{{ cls.className }}</td>
                      <td>{{ cls.objectCount.toLocaleString() }}</td>
                      <td>{{ formatBytes(cls.totalSize) }}</td>
                      <td>{{ formatBytes(cls.avgSize) }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Memory Leak Analysis -->
          <div class="memory-leak-results" *ngIf="selectedAnalysisType === 'memoryLeak' && analysisResults.suspectedLeaks">
            <h4>Suspected Memory Leaks</h4>
            <div class="leak-cards">
              <div class="leak-card" *ngFor="let leak of analysisResults.suspectedLeaks">
                <div class="leak-header">
                  <div class="leak-class">{{ leak.className }}</div>
                  <div class="leak-size">{{ formatBytes(leak.totalSize) }}</div>
                </div>
                <div class="leak-details">
                  <div class="leak-detail">
                    <span class="detail-label">Instance Count:</span>
                    <span class="detail-value">{{ leak.instanceCount.toLocaleString() }}</span>
                  </div>
                  <div class="leak-detail">
                    <span class="detail-label">Suspicion:</span>
                    <span class="detail-value">{{ leak.suspicionReason }}</span>
                  </div>
                  <div class="leak-detail" *ngIf="leak.retentionPath">
                    <span class="detail-label">Retention Path:</span>
                    <span class="detail-value">{{ leak.retentionPath }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Growth Patterns -->
            <div class="growth-patterns" *ngIf="analysisResults.growthPatterns && analysisResults.growthPatterns.length > 0">
              <h4>Growth Patterns</h4>
              <div class="growth-table">
                <table>
                  <thead>
                    <tr>
                      <th>Class</th>
                      <th>Growth Rate</th>
                      <th>Estimated Time to OOM</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let pattern of analysisResults.growthPatterns">
                      <td>{{ pattern.className }}</td>
                      <td>{{ pattern.growthRate }}</td>
                      <td>{{ pattern.timeToOOM }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Comprehensive Analysis -->
          <div class="comprehensive-results" *ngIf="selectedAnalysisType === 'comprehensive' && analysisResults.analyses">
            <div class="analysis-sections">
              <div class="analysis-section" *ngFor="let analysis of analysisResults.analyses; let i = index">
                <div class="section-header" (click)="toggleSection(i)">
                  <h4>{{ analysis.title }}</h4>
                  <i class="fas" [ngClass]="expandedSections[i] ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                </div>
                <div class="section-content" [ngClass]="{'expanded': expandedSections[i]}">
                  <p class="section-description" *ngIf="analysis.description">{{ analysis.description }}</p>

                  <div class="findings-table" *ngIf="analysis.findings && analysis.findings.length > 0">
                    <table>
                      <thead>
                        <tr>
                          <th>Finding</th>
                          <th>Value</th>
                          <th>Impact</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let finding of analysis.findings">
                          <td>{{ finding.key }}</td>
                          <td>{{ finding.value }}</td>
                          <td [ngClass]="{'high-impact': finding.impact.includes('High') || finding.impact.includes('Critical'),
                                         'medium-impact': finding.impact.includes('Medium'),
                                         'low-impact': finding.impact.includes('Low') || finding.impact.includes('Normal')}">
                            {{ finding.impact }}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No data message -->
  <div class="no-data-message" *ngIf="!isLoading && !memoryData && !heapDumpExists">
    <i class="fas fa-exclamation-circle"></i>
    <h3>No Memory Data Available</h3>
    <p>Unable to retrieve memory information from the actuator endpoint.</p>
    <p>Make sure the memory endpoint is enabled in your Spring Boot application.</p>
    <p>You can still create a heap dump by clicking the "Save Heap Dump to Server" button above.</p>
  </div>
</div>
