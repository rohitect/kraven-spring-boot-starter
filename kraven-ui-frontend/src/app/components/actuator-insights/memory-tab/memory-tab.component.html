<div class="memory-tab-container">
  <div class="tab-header">
    <h2>Memory Analysis</h2>
    <div class="tab-controls">
      <div class="refresh-interval-control">
        <label for="refreshInterval">Auto-refresh:</label>
        <select id="refreshInterval" [(ngModel)]="refreshInterval" (change)="updateRefreshInterval()">
          <option [value]="5">5 seconds</option>
          <option [value]="10">10 seconds</option>
          <option [value]="15">15 seconds</option>
          <option [value]="30">30 seconds</option>
          <option [value]="60">1 minute</option>
        </select>
      </div>
      <button class="refresh-button" (click)="forceRefresh()">
        <i class="fas fa-sync-alt"></i> Refresh Now
      </button>
    </div>
  </div>

  <!-- Loading indicator -->
  <div class="loading-indicator" *ngIf="isLoading">
    <i class="fas fa-spinner fa-spin"></i>
    <span>Loading memory data...</span>
  </div>

  <!-- Heap Dump Request Notification -->
  <div class="heap-dump-notification" *ngIf="showHeapDumpRequested" [ngClass]="heapDumpRequestStatus">
    <div class="notification-content">
      <i class="fas" [ngClass]="heapDumpRequestStatus === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'"></i>
      <span>{{ heapDumpRequestMessage }}</span>
    </div>
    <button class="close-button" (click)="closeHeapDumpNotification()">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Secondary Tabs -->
  <div class="secondary-tabs" *ngIf="!isLoading && memoryData">
    <div class="tab" [class.active]="activeSecondaryTab === 'overview'" (click)="switchSecondaryTab('overview')">
      <i class="fas fa-chart-pie"></i> Overview
    </div>
    <div class="tab" [class.active]="activeSecondaryTab === 'heap'" (click)="switchSecondaryTab('heap')">
      <i class="fas fa-memory"></i> Heap Memory
    </div>
    <div class="tab" [class.active]="activeSecondaryTab === 'nonheap'" (click)="switchSecondaryTab('nonheap')">
      <i class="fas fa-microchip"></i> Non-Heap Memory
    </div>
    <div class="tab" [class.active]="activeSecondaryTab === 'gc'" (click)="switchSecondaryTab('gc')">
      <i class="fas fa-trash-alt"></i> Garbage Collection
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content" *ngIf="!isLoading && memoryData">
    <!-- Overview Tab -->
    <div class="memory-overview" *ngIf="activeSecondaryTab === 'overview'">
      <div class="memory-summary">
        <div class="memory-card">
          <div class="memory-card-header">
            <h3>Heap Memory</h3>
            <div class="memory-actions">
              <button class="heap-dump-button" (click)="requestHeapDump()">
                <i class="fas fa-download"></i> Request Heap Dump
              </button>
            </div>
          </div>
          <div class="memory-card-content">
            <div class="memory-usage">
              <div class="memory-usage-header">
                <span>Used</span>
                <span>{{ formatBytes(memoryData?.heap?.used || 0) }} / {{ formatBytes(memoryData?.heap?.max || 0) }}</span>
              </div>
              <div class="memory-progress-bar">
                <div class="memory-progress" 
                     [style.width.%]="calculatePercentage(memoryData?.heap?.used || 0, memoryData?.heap?.max || 0)"
                     [style.background-color]="getColorByPercentage(calculatePercentage(memoryData?.heap?.used || 0, memoryData?.heap?.max || 0))">
                </div>
              </div>
              <div class="memory-usage-details">
                <div class="memory-detail">
                  <span>Init</span>
                  <span>{{ formatBytes(memoryData?.heap?.init || 0) }}</span>
                </div>
                <div class="memory-detail">
                  <span>Committed</span>
                  <span>{{ formatBytes(memoryData?.heap?.committed || 0) }}</span>
                </div>
                <div class="memory-detail">
                  <span>Used</span>
                  <span>{{ formatBytes(memoryData?.heap?.used || 0) }}</span>
                </div>
                <div class="memory-detail">
                  <span>Max</span>
                  <span>{{ formatBytes(memoryData?.heap?.max || 0) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="memory-card">
          <div class="memory-card-header">
            <h3>Non-Heap Memory</h3>
          </div>
          <div class="memory-card-content">
            <div class="memory-usage">
              <div class="memory-usage-header">
                <span>Used</span>
                <span>{{ formatBytes(memoryData?.nonHeap?.used || 0) }} / {{ formatBytes(memoryData?.nonHeap?.committed || 0) }}</span>
              </div>
              <div class="memory-progress-bar">
                <div class="memory-progress" 
                     [style.width.%]="calculatePercentage(memoryData?.nonHeap?.used || 0, memoryData?.nonHeap?.committed || 0)"
                     [style.background-color]="getColorByPercentage(calculatePercentage(memoryData?.nonHeap?.used || 0, memoryData?.nonHeap?.committed || 0))">
                </div>
              </div>
              <div class="memory-usage-details">
                <div class="memory-detail">
                  <span>Init</span>
                  <span>{{ formatBytes(memoryData?.nonHeap?.init || 0) }}</span>
                </div>
                <div class="memory-detail">
                  <span>Committed</span>
                  <span>{{ formatBytes(memoryData?.nonHeap?.committed || 0) }}</span>
                </div>
                <div class="memory-detail">
                  <span>Used</span>
                  <span>{{ formatBytes(memoryData?.nonHeap?.used || 0) }}</span>
                </div>
                <div class="memory-detail">
                  <span>Max</span>
                  <span>{{ formatBytes(memoryData?.nonHeap?.max || 0) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Memory Pools Overview -->
      <div class="memory-pools-section">
        <h3>Memory Pools</h3>
        <div class="memory-pools">
          <div class="memory-pool" *ngFor="let pool of memoryData?.memoryPools">
            <div class="memory-pool-header">
              <span class="memory-pool-name">{{ pool.name }}</span>
              <span class="memory-pool-type">{{ pool.type }}</span>
            </div>
            <div class="memory-usage">
              <div class="memory-usage-header">
                <span>Used</span>
                <span>{{ formatBytes(pool.usage?.used || 0) }} / {{ formatBytes(pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0) }}</span>
              </div>
              <div class="memory-progress-bar">
                <div class="memory-progress" 
                     [style.width.%]="calculatePercentage(pool.usage?.used || 0, pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0)"
                     [style.background-color]="getColorByPercentage(calculatePercentage(pool.usage?.used || 0, pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0))">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- GC Overview -->
      <div class="gc-section">
        <h3>Garbage Collectors</h3>
        <div class="gc-collectors">
          <div class="gc-collector" *ngFor="let gc of memoryData?.garbageCollectors">
            <div class="gc-collector-header">
              <span class="gc-collector-name">{{ gc.name }}</span>
            </div>
            <div class="gc-collector-stats">
              <div class="gc-stat">
                <span>Collection Count</span>
                <span>{{ gc.collectionCount }}</span>
              </div>
              <div class="gc-stat">
                <span>Collection Time</span>
                <span>{{ gc.collectionTime }} ms</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Heap Memory Tab -->
    <div class="memory-detail-view" *ngIf="activeSecondaryTab === 'heap'">
      <div class="memory-detail-header">
        <h3>Heap Memory Details</h3>
        <div class="memory-actions">
          <button class="heap-dump-button" (click)="requestHeapDump()">
            <i class="fas fa-download"></i> Request Heap Dump
          </button>
        </div>
      </div>

      <!-- Heap Memory Pools -->
      <div class="memory-pools-detailed">
        <div class="memory-pool-detailed" *ngFor="let pool of memoryData?.memoryPools">
          <ng-container *ngIf="pool.type === 'Heap memory'">
            <div class="memory-pool-header">
              <h4>{{ pool.name }}</h4>
            </div>
            <div class="memory-pool-content">
              <div class="memory-usage">
                <div class="memory-usage-header">
                  <span>Used</span>
                  <span>{{ formatBytes(pool.usage?.used || 0) }} / {{ formatBytes(pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0) }}</span>
                </div>
                <div class="memory-progress-bar">
                  <div class="memory-progress" 
                       [style.width.%]="calculatePercentage(pool.usage?.used || 0, pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0)"
                       [style.background-color]="getColorByPercentage(calculatePercentage(pool.usage?.used || 0, pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0))">
                  </div>
                </div>
                <div class="memory-usage-details">
                  <div class="memory-detail">
                    <span>Init</span>
                    <span>{{ formatBytes(pool.usage?.init || 0) }}</span>
                  </div>
                  <div class="memory-detail">
                    <span>Committed</span>
                    <span>{{ formatBytes(pool.usage?.committed || 0) }}</span>
                  </div>
                  <div class="memory-detail">
                    <span>Used</span>
                    <span>{{ formatBytes(pool.usage?.used || 0) }}</span>
                  </div>
                  <div class="memory-detail">
                    <span>Max</span>
                    <span>{{ formatBytes(pool.usage?.max || 0) }}</span>
                  </div>
                </div>
              </div>

              <!-- Peak Usage -->
              <div class="memory-usage" *ngIf="pool.peakUsage">
                <h5>Peak Usage</h5>
                <div class="memory-usage-header">
                  <span>Used</span>
                  <span>{{ formatBytes(pool.peakUsage?.used || 0) }} / {{ formatBytes(pool.peakUsage?.max > 0 ? pool.peakUsage?.max : pool.peakUsage?.committed || 0) }}</span>
                </div>
                <div class="memory-progress-bar">
                  <div class="memory-progress" 
                       [style.width.%]="calculatePercentage(pool.peakUsage?.used || 0, pool.peakUsage?.max > 0 ? pool.peakUsage?.max : pool.peakUsage?.committed || 0)"
                       [style.background-color]="getColorByPercentage(calculatePercentage(pool.peakUsage?.used || 0, pool.peakUsage?.max > 0 ? pool.peakUsage?.max : pool.peakUsage?.committed || 0))">
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- Non-Heap Memory Tab -->
    <div class="memory-detail-view" *ngIf="activeSecondaryTab === 'nonheap'">
      <div class="memory-detail-header">
        <h3>Non-Heap Memory Details</h3>
      </div>

      <!-- Non-Heap Memory Pools -->
      <div class="memory-pools-detailed">
        <div class="memory-pool-detailed" *ngFor="let pool of memoryData?.memoryPools">
          <ng-container *ngIf="pool.type === 'Non-heap memory'">
            <div class="memory-pool-header">
              <h4>{{ pool.name }}</h4>
            </div>
            <div class="memory-pool-content">
              <div class="memory-usage">
                <div class="memory-usage-header">
                  <span>Used</span>
                  <span>{{ formatBytes(pool.usage?.used || 0) }} / {{ formatBytes(pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0) }}</span>
                </div>
                <div class="memory-progress-bar">
                  <div class="memory-progress" 
                       [style.width.%]="calculatePercentage(pool.usage?.used || 0, pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0)"
                       [style.background-color]="getColorByPercentage(calculatePercentage(pool.usage?.used || 0, pool.usage?.max > 0 ? pool.usage?.max : pool.usage?.committed || 0))">
                  </div>
                </div>
                <div class="memory-usage-details">
                  <div class="memory-detail">
                    <span>Init</span>
                    <span>{{ formatBytes(pool.usage?.init || 0) }}</span>
                  </div>
                  <div class="memory-detail">
                    <span>Committed</span>
                    <span>{{ formatBytes(pool.usage?.committed || 0) }}</span>
                  </div>
                  <div class="memory-detail">
                    <span>Used</span>
                    <span>{{ formatBytes(pool.usage?.used || 0) }}</span>
                  </div>
                  <div class="memory-detail">
                    <span>Max</span>
                    <span>{{ formatBytes(pool.usage?.max || 0) }}</span>
                  </div>
                </div>
              </div>

              <!-- Peak Usage -->
              <div class="memory-usage" *ngIf="pool.peakUsage">
                <h5>Peak Usage</h5>
                <div class="memory-usage-header">
                  <span>Used</span>
                  <span>{{ formatBytes(pool.peakUsage?.used || 0) }} / {{ formatBytes(pool.peakUsage?.max > 0 ? pool.peakUsage?.max : pool.peakUsage?.committed || 0) }}</span>
                </div>
                <div class="memory-progress-bar">
                  <div class="memory-progress" 
                       [style.width.%]="calculatePercentage(pool.peakUsage?.used || 0, pool.peakUsage?.max > 0 ? pool.peakUsage?.max : pool.peakUsage?.committed || 0)"
                       [style.background-color]="getColorByPercentage(calculatePercentage(pool.peakUsage?.used || 0, pool.peakUsage?.max > 0 ? pool.peakUsage?.max : pool.peakUsage?.committed || 0))">
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- Garbage Collection Tab -->
    <div class="memory-detail-view" *ngIf="activeSecondaryTab === 'gc'">
      <div class="memory-detail-header">
        <h3>Garbage Collection Details</h3>
      </div>

      <!-- GC Details -->
      <div class="gc-collectors-detailed">
        <div class="gc-collector-detailed" *ngFor="let gc of memoryData?.garbageCollectors">
          <div class="gc-collector-header">
            <h4>{{ gc.name }}</h4>
          </div>
          <div class="gc-collector-content">
            <div class="gc-collector-stats">
              <div class="gc-stat">
                <span>Collection Count</span>
                <span>{{ gc.collectionCount }}</span>
              </div>
              <div class="gc-stat">
                <span>Collection Time</span>
                <span>{{ gc.collectionTime }} ms</span>
              </div>
              <div class="gc-stat">
                <span>Average Collection Time</span>
                <span>{{ gc.collectionCount > 0 ? (gc.collectionTime / gc.collectionCount).toFixed(2) : 0 }} ms</span>
              </div>
            </div>

            <!-- Memory Pools Managed by this GC -->
            <div class="gc-managed-pools" *ngIf="gc.memoryPoolNames && gc.memoryPoolNames.length > 0">
              <h5>Managed Memory Pools</h5>
              <ul class="gc-pool-list">
                <li *ngFor="let poolName of gc.memoryPoolNames">{{ poolName }}</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No data message -->
  <div class="no-data-message" *ngIf="!isLoading && !memoryData">
    <i class="fas fa-exclamation-circle"></i>
    <h3>No Memory Data Available</h3>
    <p>Unable to retrieve memory information from the actuator endpoint.</p>
    <p>Make sure the memory endpoint is enabled in your Spring Boot application.</p>
  </div>
</div>
